<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ArkLegendsPVE Sent Points Logs ‚ö°</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght=600;800&display=swap');

        /* NEW Sleek Modern Blue Palette (with Log Colors) */
        :root {
            --modern-darkest: #121212;
            --modern-dark-bg: #1e1e1e;
            --modern-accent-blue: #00AEEF;
            --modern-light-blue: #66CCFF;
            --modern-text-light: #E0E0E0;
            --modern-shadow-glow: rgba(0, 174, 239, 0.4);
            --modern-input-bg: #2b2b2b;
            --modern-border: #3A3A3A;
            --modern-secondary-text: #B0B0B0;

            /* Log Entry Colors */
            --log-added-green: #2ECC71; /* Green */
            --log-deducted-red: #E74C3C; /* Red */
            --log-adjusted-blue: #3498DB; /* Blue */
            --log-other-pink: #FF69B4; /* Pink */

            --log-added-color: var(--log-added-green);
            --log-deducted-color: var(--log-deducted-red);
            --log-adjusted-color: var(--log-adjusted-blue);
            --log-other-color: var(--log-other-pink);
        }
        
        /* --- DEFAULT: DESKTOP STYLES --- */

        body {
            font-family: 'Roboto', sans-serif;
            padding: 30px; /* Base padding */
            background: var(--modern-darkest);
            min-height: 100vh;
            margin: 0;
            color: var(--modern-text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden; /* Prevent global horizontal scroll */
            line-height: 1.6; 
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--modern-text-light);
            text-shadow: 0 0 15px var(--modern-shadow-glow);
            font-size: 3.5em;
            letter-spacing: 5px;
            margin: 0;
            position: relative;
            z-index: 1;
            white-space: nowrap;
            text-transform: uppercase;
        }

        h1::after {
            content: '';
            display: block;
            width: 100%;
            height: 3px;
            background: var(--modern-accent-blue);
            margin: 10px auto 0;
            border-radius: 2px;
            box-shadow: 0 0 10px var(--modern-shadow-glow);
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .input-form, .list-container {
            min-width: 350px;
            padding: 40px;
            border-radius: 8px;
            background-color: var(--modern-dark-bg);
            border: 1px solid var(--modern-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 174, 239, 0.1);
            transition: all 0.3s ease-in-out;
            box-sizing: border-box;
            z-index: 1;
        }

        .input-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .list-container {
            flex: 2;
            min-width: 700px;
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--modern-accent-blue);
            border-bottom: 3px solid var(--modern-border);
            padding-bottom: 12px;
            margin-top: 0;
            font-size: 1.8em;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(0, 174, 239, 0.5);
            text-transform: uppercase;
            align-self: stretch;
            text-align: center; 
        }

        /* --- Input and Select Styling: Desktop --- */
        input[type="text"],
        #miscReasonInput,
        #otherActionInput,
        #nameId,
        #amountInput,
        #whatFor,
        #actionSelect,
        #searchBar,
        #noteInput { /* Added #noteInput */
            font-family: 'Roboto', sans-serif;
            padding: 15px;
            margin: 12px 0;
            border-radius: 4px;
            font-size: 1.1em;
            background-color: var(--modern-input-bg);
            color: var(--modern-text-light);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
            transition: border-color 0.2s, box-shadow 0.2s;
            border: 1px solid var(--modern-border);
            align-self: stretch;
            box-sizing: border-box;
        }

        #nameId, #amountInput, #whatFor, #actionSelect, #noteInput { /* Added #noteInput */
            border: 1px solid var(--modern-accent-blue);
            box-shadow: 0 0 5px rgba(0, 174, 239, 0.3), inset 0 1px 3px rgba(0, 0, 0, 0.6);
        }

        #whatFor, #actionSelect {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23E0E0E0%22%20d%3D%22M287%20197.35L146.2%2056.65L5.4%20197.35z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat, repeat;
            background-position: right .7em top 50%, 0 0;
            background-size: .65em auto, 100%;
            cursor: pointer;
        }
        
        /* --- ACTION TYPE DROPDOWN COLORING --- */
        #actionSelect option[value="Added"] {
            color: var(--log-added-green);
            font-weight: bold;
        }
        #actionSelect option[value="Deducted"] {
            color: var(--log-deducted-red);
            font-weight: bold;
        }
        #actionSelect option[value="Balance Adjusted"] {
            color: var(--log-adjusted-blue);
            font-weight: bold;
        }
        #actionSelect option[value="Other Action"] {
            color: var(--log-other-pink);
            font-weight: bold;
        }
        #actionSelect option[disabled] {
            color: var(--modern-secondary-text); 
            font-weight: normal;
        }

        /* --- Button Styles: Desktop --- */
        button {
            font-family: 'Montserrat', sans-serif;
            background: var(--modern-accent-blue);
            color: var(--modern-darkest);
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            min-width: 200px;
            max-width: 90%;
            width: 90%;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-top: 30px;
            gap: 12px;
            align-items: center;
        }

        .button-group button {
            margin-top: 0;
            width: 90%;
            max-width: 350px;
        }

        #addToListBtn {
            padding: 15px 35px;
            font-size: 1.3em;
            border: 2px solid var(--modern-text-light);
        }
        
        /* --- DANGER & INFO BUTTON STYLING (Desktop) --- */
        .danger-button { background: #E74C3C; border: 2px solid #C0392B; color: var(--modern-text-light); }
        .danger-button:hover { background: #C0392B; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.5); }
        .info-button { background: #2C3E50; border: 2px solid #34495E; color: var(--modern-text-light); }
        .info-button:hover { background: #34495E; box-shadow: 0 4px 15px rgba(44, 62, 80, 0.5); }

        /* --- POINTS REFERENCE LAYOUT: Desktop --- */
        .points-reference {
            margin-top: 30px;
            align-self: stretch;
            padding: 15px;
            background-color: #242424;
            border-radius: 4px;
            border: 1px dashed var(--modern-border);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .reference-section {
            padding-top: 10px;
            min-width: 250px;
            flex-grow: 1;
            flex-basis: 0;
        }

        .reference-section h3 {
             text-align: center;
        }
        
        .reference-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* JAZZED UP AWARDS STYLES */
        .points-list-item {
            font-size: 1.0em;
            padding: 8px 0;
            border-bottom: 1px dashed var(--modern-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .points-list-item:last-child {
            border-bottom: none;
        }

        .points-list-item strong {
            color: var(--modern-light-blue);
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            margin-left: 10px;
        }

        /* COLOR KEY SWATCHES */
        .color-swatch {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid;
        }

        .swatch-added { background-color: var(--log-added-color); border-color: var(--log-added-color); }
        .swatch-deducted { background-color: var(--log-deducted-color); border-color: var(--log-deducted-color); }
        .swatch-adjusted { background-color: var(--log-adjusted-color); border-color: var(--log-adjusted-color); }
        .swatch-other { background-color: var(--log-other-color); border-color: var(--log-other-color); }


        /* --- LOG ENTRY AGGRESSIVE COMPACTION STYLING (Desktop) --- */
        #entryList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #entryList li {
            /* Aggressively Tighter Vertical Spacing */
            background: var(--modern-input-bg);
            margin: 4px 0; /* Minimized margin */
            padding: 6px; /* Minimized padding */
            border-radius: 4px;
            border: 1px solid; 
            font-size: 0.8em; /* Base smaller font for log entries */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative; /* Needed for delete button positioning */
            padding-right: 40px; /* Space for the delete button */
        }

        .log-content {
            /* Single line structure (Desktop) */
            display: flex;
            flex-wrap: nowrap;
            width: 100%;
            align-items: center;
            padding-bottom: 2px; 
            border-bottom: none; 
            margin-bottom: 0; 
        }

        .log-segment {
            padding: 0 8px 0 0; /* Minimal padding between segments */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
            flex-basis: auto;
        }
        
        .log-segment strong {
            font-weight: 500; 
            color: var(--modern-secondary-text); 
            margin-right: 3px;
        }

        /* Desktop Log Segment Widths - Player name reverted to original size (inherited 0.8em) */
        .log-segment-name { 
            flex-basis: 220px; 
            font-weight: 700; 
            color: var(--modern-accent-blue); 
            min-width: 180px;
        }
        
        .log-segment-action {
             flex-basis: 180px; 
             min-width: 150px;
        }
        .log-segment-amount { 
            flex-basis: 120px; 
            font-weight: 900; 
            text-shadow: 0 0 5px rgba(102, 204, 255, 0.4);
            min-width: 100px;
        }
        .log-segment-reason { 
            flex-grow: 1; 
            min-width: 200px; 
            white-space: normal;
        }
        
        /* New line for notes */
        .log-segment-note {
            display: block; /* Make it take up its own line */
            width: 100%;
            padding: 3px 0 0 0;
            color: var(--modern-secondary-text);
            font-style: italic;
            border-top: 1px dashed var(--modern-border);
            margin-top: 4px;
            padding-top: 4px;
        }
        .log-segment-note strong {
             font-style: normal;
             color: var(--modern-text-light);
             font-weight: 700;
        }


        /* Specific coloring for the Amount based on action class */
        #entryList li.added .log-segment-amount { color: var(--log-added-color); }
        #entryList li.deducted .log-segment-amount { color: var(--log-deducted-color); }
        #entryList li.adjusted .log-segment-amount { color: var(--log-adjusted-color); }
        #entryList li.other .log-segment-amount { color: var(--log-other-color); }


        .log-timestamp {
            font-family: 'Roboto', sans-serif;
            font-size: 0.65em; /* Extremely small timestamp */
            color: #AAAAAA;
            display: block;
            padding: 1px 0 0 0; 
            width: 100%;
            text-align: right;
            margin-top: 1px; 
        }

        /* --- Log Color Borders --- */
        #entryList li.added { border-color: var(--log-added-color); }
        #entryList li.deducted { border-color: var(--log-deducted-color); }
        #entryList li.adjusted { border-color: var(--log-adjusted-color); }
        #entryList li.other { border-color: var(--log-other-color); }
        
        /* --- SEARCH BAR AND BUTTON CONTAINER STYLING --- */
        .search-container {
            display: flex;
            gap: 10px;
            width: 100%;
            align-items: center;
        }
        #searchBar {
            flex-grow: 1;
            margin: 12px 0; /* Align with input field margins */
            min-width: 0;
        }
        #searchButton {
            /* Inherit button styles but modify size for the search container */
            width: 100px; /* Fixed width for search button */
            min-width: 0;
            padding: 15px 10px;
            margin: 12px 0; /* Align with input field margins */
            font-size: 1.1em;
            text-transform: none; /* Keep capitalization simple */
            box-shadow: none;
        }
        /* --- END SEARCH STYLING --- */

        /* --- DELETE BUTTON STYLING (Desktop & Mobile) --- */
        .delete-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--log-deducted-red);
            font-size: 1.5em;
            font-weight: 900;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 5;
        }
        .delete-btn:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }
        /* --- END DELETE BUTTON STYLING --- */


        /* --- RESPONSIVE ADJUSTMENTS (Mobile Readability Fix) --- */
        
        /* Tablet/Mid-Sized Screens */
        @media (max-width: 1100px) {
            .input-form, .list-container {
                flex: 1 1 100%;
                min-width: 100%;
            }
        }
        
        /* Mobile Screens */
        @media (max-width: 768px) {
            body {
                padding: 15px; 
            }

            h1 {
                font-size: 2.2em; 
                letter-spacing: 2px;
                white-space: normal;
                line-height: 1.2;
            }

            .input-form, .list-container {
                padding: 20px;
            }

            .search-container {
                 flex-direction: column;
                 gap: 0;
            }
            #searchBar {
                 margin-bottom: 0;
                 width: 100%;
            }
            #searchButton {
                 margin-top: 10px;
                 width: 100%;
                 max-width: 100%;
            }
            
            /* --- LOG ENTRY MOBILE FIXES --- */
            
            #entryList li {
                font-size: 0.9em; /* Increased base font for mobile legibility */
                padding: 8px 40px 8px 8px; /* Added right padding for delete button on mobile */
            }

            /* Stack log segments vertically */
            .log-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .log-segment {
                /* RESTORING PADDING for stacked elements */
                padding: 3px 0; 
                width: 100%;
                box-sizing: border-box;
                white-space: normal;
                text-overflow: unset;
                overflow: visible;
            }
            
            /* Add separation line after the amount */
            .log-segment-amount {
                padding-bottom: 5px;
                border-bottom: 1px dashed var(--modern-border); 
                margin-bottom: 5px;
            }

            /* Remove specific fixed widths on mobile */
            .log-segment-name,
            .log-segment-amount,
            .log-segment-action,
            .log-segment-reason {
                flex-basis: auto;
                min-width: unset;
                width: 100%;
            }

            /* Mobile Player Name Size Adjustment */
            .log-segment-name {
                 font-size: 0.8em; 
            }
            
            /* Ensure timestamp is legible and left-aligned */
            .log-timestamp {
                text-align: left;
                font-size: 0.75em;
                margin-top: 3px;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            ArkLegendsPVE Sent Points Logs
        </h1>
    </header>

    <div class="container">
        <div class="input-form">
            <h2>‚ûï Add Points Log</h2>
            <input type="text" id="nameId" placeholder="Player Name/EOS ID">

            <select id="actionSelect">
                <option value="" disabled selected>--- Select Action Type ---</option>
                <option value="Added">Added</option>
                <option value="Deducted">Deducted</option>
                <option value="Balance Adjusted">Balance Adjusted</option>
                <option value="Other Action">Other Action</option>
            </select>

            <input type="text" id="otherActionInput" placeholder="Specify Other Action" style="display:none;">

            <input type="text" id="amountInput" placeholder="Amount (e.g., 5000)">

            <select id="whatFor">
                <option value="" disabled selected>--- Select Reason for Points ---</option>
                <option value="This months Legend (5k)">This months Legend (5k)</option>
                <option value="Discord Boost (1k points)">Discord boost (1k points)</option>
                <option value="Server Donation (1k points)">Server donation (1k points)</option>
                <option value="Mod Developer Donation (1k points)">Mod developer donation (1k points)</option>
                <option value="Mee6 Lvl 10 (2k points)">Mee6 Lvl 10 (2k points)</option>
                <option value="Mee6 Lvl 15 (3k points)">Mee6 Lvl 15 (3k points)</option>
                <option value="Mee6 Lvl 20 (4k points)">Mee6 Lvl 20 (4k points)</option>
                <option value="1st in Accessories Leaderboard (5k points)">1st in Accessories Leaderboard (5k points)</option>
                <option value="2nd in Accessories Leaderboard (3k points)">2nd in Accessories Leaderboard (3k points)</option>
                <option value="3rd in Accessories Leaderboard (1k points)">3rd in Accessories Leaderboard (1k points)</option>
                <option value="Completing the Feedback Survey (2.5k)">Completing the feedback survey (2.5k)</option>
                <option value="Bought in another player (1k)">Bought in another player (1k)</option>
                <option value="Shop Refund">Shop refund</option>
                <option value="Misc">Misc</option>
            </select>

            <input type="text" id="miscReasonInput" placeholder="Specify Misc Reason" style="display:none;">
            
            <input type="text" id="noteInput" placeholder="Optional: Add a specific note or comment">

            <div class="button-group">
                <button id="addToListBtn">Save to Log</button>
                <button id="downloadLogBtn">Download Log (.txt)</button>
                <button id="clearLogLocalBtn" class="info-button">Clear Local Display (Server Data Stays)</button>
                <button id="clearLogBtn" class="danger-button">Clear ALL Entries (Server & Local)</button>
            </div>

            <div class="points-reference">
                <div class="reference-section standard-awards">
                    <h3>‚≠ê Standard Point Awards Reference</h3>
                    <ul class="points-list">
                        <li class="points-list-item">
                            <span>üëë Legend of the Month:</span>
                            <strong>5,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üöÄ Discord Boost:</span>
                            <strong>1,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üíé Server/Mod Donation:</span>
                            <strong>1,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üèÖ Mee6 Lvl 10:</span>
                            <strong>2,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üèÜ Mee6 Lvl 15:</span>
                            <strong>3,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üëë Mee6 Lvl 20:</span>
                            <strong>4,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>ü•á Accessories 1st Place:</span>
                            <strong>5,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>ü•à Accessories 2nd Place:</span>
                            <strong>3,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>ü•â Accessories 3rd Place:</span>
                            <strong>1,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üìù Feedback Survey:</span>
                            <strong>2,500 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>ü§ù Bought in New Player:</span>
                            <strong>1,000 pts</strong>
                        </li>
                        <li class="points-list-item">
                            <span>üîÑ Shop Refund:</span>
                            <strong>*Variable*</strong>
                        </li>
                    </ul>
                </div>

                <div class="reference-section color-key">
                    <h3>üé® Log Color Key</h3>
                    <ul>
                        <li><span class="color-swatch swatch-added"></span> <strong>Green:</strong> Points **Added** (Credit)</li>
                        <li><span class="color-swatch swatch-deducted"></span> <strong>Red:</strong> Points **Deducted** (Debit)</li>
                        <li><span class="color-swatch swatch-adjusted"></span> <strong>Blue:</strong> **Balance Adjusted** (Correction)</li>
                        <li><span class="color-swatch swatch-other"></span> <strong>Pink:</strong> **Other Action** (Non-Point Related)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="list-container">
            <h2>üìú Points History</h2> 

            <div class="search-container">
                <input type="text" id="searchBar" placeholder="üîç Search Player, Action, Reason, or Notes...">
                <button id="searchButton">Search</button>
            </div>
            
            <ul id="entryList">
            </ul>
        </div>
    </div>

    <script>
        // *******************************************************************
        // *** ‚ö†Ô∏è CONFIGURATION: YOU MUST PASTE YOUR LIVE KEYS BELOW! ‚ö†Ô∏è ***
        // *******************************************************************
        // 1. Paste your Bin ID here:
        const BIN_ID = "YOUR_JSONBIN_BIN_ID_HERE";
        // 2. Paste your Master Key here:
        const SECRET_KEY = "YOUR_JSONBIN_MASTER_KEY_HERE"; 
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        // *******************************************************************

        // --- PASSWORD SETTING (for server-wide clear) ---
        const CLEAR_PASSWORD = "legends";
        // ------------------------------------------------

        const nameIdInput = document.getElementById('nameId');
        const actionSelect = document.getElementById('actionSelect');
        const otherActionInput = document.getElementById('otherActionInput');
        const amountInput = document.getElementById('amountInput');
        const whatForInput = document.getElementById('whatFor');
        const miscReasonInput = document.getElementById('miscReasonInput');
        const noteInput = document.getElementById('noteInput'); 
        const addToListBtn = document.getElementById('addToListBtn');
        const entryList = document.getElementById('entryList');
        const searchBar = document.getElementById('searchBar');
        const searchButton = document.getElementById('searchButton');
        const downloadLogBtn = document.getElementById('downloadLogBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const clearLogLocalBtn = document.getElementById('clearLogLocalBtn');

        let logEntries = [];

        // --- PLACEHOLDER DEFINITION (Used for saves/clears when log is empty) ---
        const PLACEHOLDER_ENTRY = {
            text: "PLACEHOLDER",
            html: "",
            search: "ignore placeholder",
            timestamp: Date.now(),
            actionClass: "other"
        };
        // --------------------------------------------------------------------------

        // --- JSONBIN Functions ---
        async function loadEntries() {
            if (BIN_ID === "YOUR_JSONBIN_BIN_ID_HERE" || SECRET_KEY === "YOUR_JSONBIN_MASTER_KEY_HERE") {
                 console.error("JSONBin API Keys not set. Log will not save or load from server. Please update the configuration.");
                 return;
            }
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'X-Master-Key': SECRET_KEY }
                });
                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("‚ùå Failed to load log from JSONBin.io. Check your Master Key and Bin ID.", errorDetails);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                const records = data.record || data;
                // FIX: Filter out non-objects or null records defensively, just in case
                logEntries = Array.isArray(records) ? records.filter(entry => entry && entry.text !== "PLACEHOLDER") : [];

                renderEntries();
                console.log("‚úÖ Log loaded from server successfully.");
            } catch (error) {
                console.error("üö® Critical Error: Could not establish connection or retrieve data. Starting with an empty log.", error);
                logEntries = [];
                renderEntries();
            }
        }

        async function saveEntries() {
            if (BIN_ID === "YOUR_JSONBIN_BIN_ID_HERE" || SECRET_KEY === "YOUR_JSONBIN_MASTER_KEY_HERE") {
                 console.error("JSONBin API Keys not set. Save aborted.");
                 return;
            }

            let dataToSend = logEntries.length > 0 ? logEntries : [PLACEHOLDER_ENTRY];

            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': SECRET_KEY },
                    body: JSON.stringify(dataToSend)
                });
                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("‚ùå Failed to save log to JSONBin.io. Check server response.", errorDetails);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                console.log("‚úÖ Log saved to server successfully.");
            } catch (error) {
                console.error("üö® Critical Error: Could not save log to server. Data may not be persistent.", error);
                alert("üö® Warning: Log could not be saved to the central server!");
            }
        }

        async function clearLog() {
            if (BIN_ID === "69389022ae596e708f8e9cb0" || SECRET_KEY === "$2a$10$AGsAc/FGcGFFtSHsaLM9de17DA4gr8Tn/A1ZD6B1NkQHITT2Mb21y") {
                 alert("Cannot clear server log: API keys are not configured.");
                 return;
            }

            const passwordAttempt = prompt("‚ö†Ô∏è WARNING: This will permanently delete ALL log entries from the SERVER. Please enter the password to confirm:");

            if (passwordAttempt !== CLEAR_PASSWORD) {
                alert("Invalid password. Log clear cancelled.");
                return;
            }

            const originalEntries = [...logEntries];
            const dataToClear = [PLACEHOLDER_ENTRY];

            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': SECRET_KEY },
                    body: JSON.stringify(dataToClear)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("‚ùå Failed to clear log on JSONBin.io.", errorDetails);
                    throw new Error(`Server PUT failed. Status: ${response.status}`);
                }

                logEntries = [];
                renderEntries();
                alert("‚úÖ Log has been successfully cleared from the server.");

            } catch (error) {
                console.error("üö® FATAL ERROR: Could not clear log on server.", error);
                logEntries = originalEntries;
                renderEntries();
                alert("üö® FATAL ERROR: Log could not be cleared on the central server! The local log has been restored.");
            }
        }

        function clearLogLocal() {
            if (confirm("Are you sure you want to clear the local display? The log data will REMAIN on the server and reload when the page is refreshed.")) {
                entryList.innerHTML = '';
                alert("Local display cleared. Data remains safe on the server. Reloading the page will bring it back.");
            }
        }
        
        // --- Individual Delete Handler ---
        async function deleteEntry(event) {
            // Find the list item parent
            const listItem = event.target.closest('li');
            if (!listItem) return;

            const entryIndexText = event.target.getAttribute('data-entry-index');
            const entryIndex = parseInt(entryIndexText, 10);
            
            if (isNaN(entryIndex) || entryIndex < 0 || entryIndex >= logEntries.length) {
                console.error("Invalid entry index for deletion.");
                alert("Error: Cannot delete this entry. Data index is corrupted.");
                return;
            }
            
            const entry = logEntries[entryIndex];
            
            if (!confirm(`Are you sure you want to delete this entry?\n\nAction: ${entry.text.split(' | ')[0]}\nPlayer: ${entry.text.split(' | Player: ')[1].split(' | Reason: ')[0]}`)) {
                return;
            }

            // Remove entry from local array using the correct index
            logEntries.splice(entryIndex, 1);

            // Re-render and save the new list to the server
            renderEntries();
            await saveEntries();
            
            alert("Entry deleted and log saved.");
        }


        // --- UTILITY FUNCTIONS ---

        function getActionClass(action) {
            if (action.includes('Added')) return 'added';
            if (action.includes('Deducted')) return 'deducted';
            if (action.includes('Balance Adjusted')) return 'adjusted';
            return 'other';
        }

        function renderEntries() {
            // FIX: Ensure list is completely cleared before rendering.
            entryList.innerHTML = '';
            
            // Assign the index (position in the logEntries array) to each entry.
            const entriesToRender = logEntries.map((entry, index) => ({...entry, originalIndex: index}));
            
            // Render in reverse order (newest first)
            entriesToRender.slice().reverse().forEach(indexedEntry => {
                const listItem = document.createElement('li');
                
                // 1. Create Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-btn');
                deleteButton.setAttribute('data-entry-index', indexedEntry.originalIndex);
                deleteButton.setAttribute('title', 'Delete Log Entry');
                deleteButton.innerHTML = '&times;';
                deleteButton.addEventListener('click', deleteEntry);

                // 2. Append Button and HTML Content
                listItem.appendChild(deleteButton);
                // The issue often happens here if indexedEntry.html is undefined or null on first load.
                // Since we filtered out non-objects in loadEntries, this should be safer now.
                listItem.insertAdjacentHTML('beforeend', indexedEntry.html);
                
                // 3. Set Attributes and Class
                listItem.setAttribute('data-search-term', indexedEntry.search);
                listItem.classList.add(indexedEntry.actionClass);
                
                // 4. Append to List
                entryList.appendChild(listItem);
            });
        }

        function getFormattedDateTime() {
            const now = new Date();
            const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const datePart = now.toLocaleDateString('en-GB', dateOptions);
            const timePart = now.toLocaleTimeString('en-US', timeOptions);
            return `${datePart} at ${timePart}`;
        }

        // --- Search Functionality ---
        function performSearch() {
            const searchTerm = searchBar.value.toLowerCase().trim();
            const listItems = entryList.getElementsByTagName('li');

            Array.from(listItems).forEach(item => {
                const searchData = item.getAttribute('data-search-term');
                if (searchData && searchData.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // --- Event listeners ---
        whatForInput.addEventListener('change', function() {
            if (whatForInput.value === 'Misc') {
                miscReasonInput.style.display = 'block';
                miscReasonInput.focus();
            } else {
                miscReasonInput.style.display = 'none';
                miscReasonInput.value = '';
            }
        });

        actionSelect.addEventListener('change', function() {
            if (actionSelect.value === 'Other Action') {
                otherActionInput.style.display = 'block';
                otherActionInput.focus();
            } else {
                otherActionInput.style.display = 'none';
                otherActionInput.value = '';
            }
        });

        addToListBtn.addEventListener('click', async function() {
            const nameId = nameIdInput.value.trim();
            let whatDid = actionSelect.value;
            const amount = amountInput.value.trim();
            let whatFor = whatForInput.value;
            const note = noteInput.value.trim(); 
            const timestamp = getFormattedDateTime();
            
            // Generate display note content (show N/A if empty)
            const displayNote = note === '' ? "N/A" : note;
            // Generate a separate line for the note if it exists
            const noteLineHtml = note === '' ? '' : `<span class="log-segment log-segment-note"><strong>Note:</strong> ${note}</span>`;


            if (nameId === '' || whatDid === '' || whatDid === '--- Select Action Type ---') {
                alert('Please fill in the Player name and select an Action Type!');
                return;
            }

            if (whatDid === 'Other Action') {
                const otherAction = otherActionInput.value.trim();
                if (otherAction === '') {
                    alert('You selected "Other Action." Please specify the action in the box that appeared.');
                    return;
                }
                whatDid = `Other Action: ${otherAction}`;
            }

            if (amount === '') {
                alert('Please enter an Amount for the transfer!');
                return;
            }

            if (whatFor === '' || whatFor === '--- Select Reason for Points ---') {
                alert('Please select a valid Reason for the points transfer!');
                return;
            }

            if (whatFor === 'Misc') {
                const miscReason = miscReasonInput.value.trim();
                if (miscReason === '') {
                    alert('You selected "Misc Reason." Please specify the reason in the box that appeared.');
                    return;
                }
                whatFor = `Misc: ${miscReason}`;
            }

            const actionClass = getActionClass(actionSelect.value);

            // HTML FORMAT FOR DISPLAY
            const entryHtml = `
                <div class="log-content">
                    <span class="log-segment log-segment-name"><strong>Player:</strong> ${nameId}</span>
                    <span class="log-segment log-segment-action"><strong>Action:</strong> ${whatDid}</span>
                    <span class="log-segment log-segment-amount"><strong>Amount:</strong> ${amount}</span>
                    <span class="log-segment log-segment-reason"><strong>Reason:</strong> ${whatFor}</span>
                </div>
                ${noteLineHtml}
                <span class="log-timestamp">Logged: ${timestamp}</span>
            `;

            // TEXT FORMAT FOR DOWNLOAD (.txt)
            const entryText = `${whatDid} | Amount: ${amount} | Player: ${nameId} | Reason: ${whatFor} | Note: ${displayNote} | Logged: ${timestamp}`;

            const newEntry = {
                text: entryText,
                html: entryHtml,
                search: `${nameId.toLowerCase()} ${whatDid.toLowerCase()} ${amount.toLowerCase()} ${whatFor.toLowerCase()} ${note.toLowerCase()}`,
                timestamp: Date.now(),
                actionClass: actionClass
            };

            logEntries.push(newEntry);
            renderEntries();
            await saveEntries();

            // Clear form inputs
            nameIdInput.value = '';
            actionSelect.value = '';
            otherActionInput.value = '';
            otherActionInput.style.display = 'none';
            amountInput.value = '';
            whatForInput.value = '';
            miscReasonInput.value = '';
            miscReasonInput.style.display = 'none';
            noteInput.value = ''; // CLEAR NEW NOTE INPUT

            alert(`‚úÖ Log entry saved for: ${nameId} (${whatDid} ${amount})`);
        });

        // Trigger search on keyup (original functionality)
        searchBar.addEventListener('keyup', performSearch);
        
        // Trigger search on button click (new functionality)
        searchButton.addEventListener('click', performSearch);

        downloadLogBtn.addEventListener('click', function() {
            if (logEntries.length === 0) {
                alert("The log is empty!");
                return;
            }

            const logText = logEntries
                .filter(entry => entry.text !== "PLACEHOLDER")
                .map(entry => entry.text)
                .join('\n');

            const filename = `ArkLegendsPVE_PointsLog_${new Date().toISOString().slice(0, 10)}.txt`;
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Log download started!");
        });

        clearLogBtn.addEventListener('click', clearLog);
        clearLogLocalBtn.addEventListener('click', clearLogLocal);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', loadEntries);
    </script>
</body>
</html>
